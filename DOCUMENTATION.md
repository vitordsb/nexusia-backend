# üìö Documenta√ß√£o T√©cnica da NexusAI API

**Vers√£o:** 1.0  
**Data:** Outubro 2025  
**Autor:** Manus AI

---

## üìñ Sum√°rio

1. [Vis√£o Geral](#-vis√£o-geral)
2. [Arquitetura do Sistema](#-arquitetura-do-sistema)
3. [Primeiros Passos](#-primeiros-passos)
4. [Autentica√ß√£o](#-autentica√ß√£o)
5. [Refer√™ncia da API](#-refer√™ncia-da-api)
6. [Sistema de Cr√©ditos e Pre√ßos](#-sistema-de-cr√©ditos-e-pre√ßos)
7. [Seguran√ßa](#-seguran√ßa)
8. [Estrutura do Projeto](#-estrutura-do-projeto)
9. [Deploy](#-deploy)

---



## 1. Vis√£o Geral

A **NexusAI API** √© um microsservi√ßo de orquestra√ß√£o de Intelig√™ncia Artificial projetado para unificar o acesso a m√∫ltiplos provedores de IA em uma √∫nica interface. Ele permite que aplica√ß√µes clientes (como o frontend da NexusAI) interajam com diversos modelos de linguagem e gera√ß√£o de imagens de forma padronizada, segura e escal√°vel.

### üéØ Objetivos

- **Unifica√ß√£o:** Prover uma API √∫nica para acessar modelos da OpenAI, Anthropic e Google.
- **Flexibilidade:** Permitir a escolha de diferentes modelos e modos de intera√ß√£o (low, medium, high).
- **Gerenciamento de Conversas:** Salvar, carregar e gerenciar o hist√≥rico de conversas dos usu√°rios.
- **Seguran√ßa:** Proteger chaves de API e garantir que usu√°rios acessem apenas seus pr√≥prios dados.
- **Escalabilidade:** Constru√≠do com tecnologias modernas e ass√≠ncronas (FastAPI, Motor) para alta performance.
- **Sistema de Cr√©ditos:** Fornecer informa√ß√µes detalhadas de uso e custo para cada requisi√ß√£o.

### ‚ú® Recursos Principais

- ‚úÖ **Chat Completions:** Acesso a 8 modelos de linguagem de 3 provedores diferentes.
- ‚úÖ **Gerenciamento de Conversas:** Armazenamento de hist√≥rico no MongoDB.
- ‚úÖ **Autentica√ß√£o JWT:** Todos os endpoints s√£o protegidos.
- ‚úÖ **Sistema de Cr√©ditos:** C√°lculo de custo em tempo real para cada requisi√ß√£o.
- ‚úÖ **Gera√ß√£o de Imagens:** Integra√ß√£o com DALL-E 3 da OpenAI.
- ‚úÖ **Web Search:** Integra√ß√£o com Google Search via SerpAPI.
- ‚úÖ **Documenta√ß√£o Autom√°tica:** Interface interativa do Swagger UI e Redoc.

### üõ†Ô∏è Tecnologias Utilizadas

| Categoria | Tecnologia | Justificativa |
|:---|:---|:---|
| **Framework Web** | FastAPI | Alta performance, ass√≠ncrono, documenta√ß√£o autom√°tica. |
| **Banco de Dados** | MongoDB | Flexibilidade (NoSQL), escalabilidade, ideal para documentos JSON. |
| **Driver do BD** | Motor | Driver oficial e ass√≠ncrono para MongoDB em Python. |
| **Valida√ß√£o de Dados** | Pydantic | Valida√ß√£o robusta de dados, schemas claros, integra√ß√£o nativa com FastAPI. |
| **Autentica√ß√£o** | JWT (python-jose) | Padr√£o de mercado para APIs, seguro e stateless. |
| **Provedores de IA** | OpenAI, Anthropic, Google | Principais provedores de modelos de linguagem. |
| **Gera√ß√£o de Imagens**| DALL-E 3 | Modelo de alta qualidade da OpenAI. |
| **Web Search** | SerpAPI | API confi√°vel para resultados do Google Search. |
| **Servidor ASGI** | Uvicorn | Servidor ASGI de alta performance para FastAPI. |

---



## 2. Arquitetura do Sistema

A arquitetura foi projetada para ser modular, escal√°vel e segura, seguindo as melhores pr√°ticas de desenvolvimento de microsservi√ßos.

###  diagrama de Arquitetura

```mermaid
graph TD
    subgraph "Plataforma NexusAI"
        A[Frontend da Aplica√ß√£o] -->|Requisi√ß√£o HTTP com Token JWT| B(NexusAI API)
    end

    subgraph "Microsservi√ßo NexusAI API (FastAPI)"
        B --> C{Router da API}
        C -->|Valida Token JWT| D[Middleware de Autentica√ß√£o]
        D --> E{Endpoints}
        E --> F[Orquestrador de IA]
        E --> G[Reposit√≥rio de Conversas]
        G --> H[(MongoDB)]
        F --> I{Padr√£o Strategy}
    end

    subgraph "Provedores de IA"
        I --> J[GPT Provider]
        I --> K[Claude Provider]
        I --> L[Gemini Provider]
        J --> M[OpenAI API]
        K --> N[Anthropic API]
        L --> O[Google Gemini API]
    end

    subgraph "Servi√ßos Adicionais"
        E --> P[Gerador de Imagens]
        P --> M
        E --> Q[Web Search]
        Q --> R[SerpAPI]
    end

    style A fill:#f9f,stroke:#333,stroke-width:2px
    style B fill:#bbf,stroke:#333,stroke-width:2px
    style H fill:#9f9,stroke:#333,stroke-width:2px
    style M fill:#ff9,stroke:#333,stroke-width:2px
    style N fill:#ff9,stroke:#333,stroke-width:2px
    style O fill:#ff9,stroke:#333,stroke-width:2px
    style R fill:#ff9,stroke:#333,stroke-width:2px
```

### üèõÔ∏è Componentes Principais

- **FastAPI App:** O ponto de entrada da aplica√ß√£o, respons√°vel por gerenciar o ciclo de vida, rotas e middlewares.
- **Middleware de Autentica√ß√£o:** Intercepta todas as requisi√ß√µes, valida o token JWT e extrai as informa√ß√µes do usu√°rio.
- **Endpoints da API:** Define todas as rotas dispon√≠veis (chat, conversas, modelos, etc.) e lida com a l√≥gica de requisi√ß√£o/resposta.
- **Orquestrador de IA:** O c√©rebro do sistema. Recebe a requisi√ß√£o do endpoint, seleciona o provedor de IA correto (usando o Padr√£o Strategy) e delega a gera√ß√£o da resposta.
- **Padr√£o Strategy:** Permite que o orquestrador trate todos os provedores de IA de forma uniforme atrav√©s de uma interface comum (`BaseProvider`). Cada provedor (GPT, Claude, Gemini) √© uma implementa√ß√£o concreta dessa interface.
- **Reposit√≥rio de Conversas:** Abstrai a l√≥gica de acesso ao banco de dados, fornecendo m√©todos para criar, ler, atualizar e deletar conversas e mensagens.
- **MongoDB (com Motor):** O banco de dados NoSQL usado para persistir todas as informa√ß√µes de usu√°rios, conversas e mensagens.
- **Provedores Externos:** As APIs de terceiros (OpenAI, Anthropic, Google, SerpAPI) que fornecem os servi√ßos de IA e busca.

### üåä Fluxo de uma Requisi√ß√£o de Chat

1. O **Frontend** envia uma requisi√ß√£o `POST /v1/chat/completions` com o prompt do usu√°rio e um token JWT no cabe√ßalho.
2. O **Middleware de Autentica√ß√£o** valida o token JWT.
3. O **Endpoint de Chat** recebe a requisi√ß√£o e a encaminha para o **Orquestrador de IA**.
4. O **Orquestrador** identifica o modelo solicitado (ex: "gpt-5-pro") e usa o **Padr√£o Strategy** para selecionar o `GptProvider`.
5. O `GptProvider` formata a requisi√ß√£o para o padr√£o da OpenAI e a envia para a **API da OpenAI**.
6. A API da OpenAI retorna a resposta.
7. O `GptProvider` padroniza a resposta (incluindo o c√°lculo de custo) e a retorna para o Orquestrador.
8. O **Orquestrador** salva a pergunta e a resposta no hist√≥rico da conversa usando o **Reposit√≥rio de Conversas**, que persiste os dados no **MongoDB**.
9. O **Endpoint** retorna a resposta padronizada para o Frontend.

---




## 3. Primeiros Passos

Este guia ir√° ajud√°-lo a configurar e executar a API localmente para desenvolvimento e testes.

### üìã Pr√©-requisitos

- **Python 3.11+**
- **MongoDB** (local ou em um servi√ßo como o MongoDB Atlas)
- **Chaves de API** dos provedores (OpenAI, Anthropic, Google)
- **SerpAPI Key** (opcional, para web search)

### ‚öôÔ∏è Instala√ß√£o

1. **Clone o reposit√≥rio:**
   ```bash
   git clone <url-do-repositorio>
   cd nexusai_api
   ```

2. **Crie e ative um ambiente virtual:**
   ```bash
   # Criar ambiente
   python -m venv .venv

   # Ativar no Windows
   .venv\Scripts\activate

   # Ativar no Linux/macOS
   source .venv/bin/activate
   ```

3. **Instale as depend√™ncias:**
   ```bash
   pip install -r requirements.txt
   ```

### üîë Configura√ß√£o das Vari√°veis de Ambiente

1. **Copie o arquivo de exemplo:**
   ```bash
   cp .env.example .env
   ```

2. **Edite o arquivo `.env`** e preencha com suas informa√ß√µes:
   ```env
   # Chave secreta para JWT (gere uma chave forte)
   JWT_SECRET_KEY=sua-chave-secreta-forte-aqui

   # URL de conex√£o do MongoDB
   MONGODB_URL=mongodb://localhost:27017

   # Chaves das APIs de IA
   OPENAI_API_KEY=sk-...
   ANTHROPIC_API_KEY=sk-ant-...
   GOOGLE_API_KEY=AIza...

   # Chave da SerpAPI (opcional)
   SERPAPI_API_KEY=...
   ```

   > **‚ö†Ô∏è Importante:** Nunca commite o arquivo `.env` no Git. Ele j√° est√° no `.gitignore` por padr√£o.

### ‚ñ∂Ô∏è Executando a API

Com o ambiente virtual ativado, execute o seguinte comando:

```bash
# Inicia o servidor com hot-reload
uvicorn app.main:app --reload
```

A API estar√° dispon√≠vel em `http://127.0.0.1:8000`.

### üìÑ Acessando a Documenta√ß√£o Interativa

Ap√≥s iniciar o servidor, voc√™ pode acessar a documenta√ß√£o autom√°tica (Swagger UI) para testar os endpoints interativamente:

- **Swagger UI:** [http://127.0.0.1:8000/docs](http://127.0.0.1:8000/docs)
- **Redoc:** [http://127.0.0.1:8000/redoc](http://127.0.0.1:8000/redoc)

![Swagger UI](https://i.imgur.com/example.png)  <!-- Placeholder para imagem do Swagger -->

---



## 4. Autentica√ß√£o

Todos os endpoints da API s√£o protegidos e requerem um **Token JWT** v√°lido no cabe√ßalho `Authorization`.

### üåä Fluxo de Autentica√ß√£o

1. O sistema principal da plataforma NexusAI √© respons√°vel por autenticar o usu√°rio (com login e senha) e gerar um token JWT.
2. O frontend recebe este token e o armazena de forma segura.
3. Para cada requisi√ß√£o √† NexusAI API, o frontend deve incluir o token no cabe√ßalho:
   ```
   Authorization: Bearer <seu_token_jwt>
   ```

### üß™ Gerando um Token de Teste (Apenas Desenvolvimento)

Para facilitar os testes durante o desenvolvimento, a API inclui um endpoint para gerar tokens de teste. **Este endpoint DEVE ser removido em produ√ß√£o.**

**Endpoint:** `POST /v1/auth/token`

**Request Body:**
```json
{
  "user_id": "seu_id_de_usuario_para_teste"
}
```

**Exemplo com cURL:**
```bash
curl -X POST "http://127.0.0.1:8000/v1/auth/token" \
  -H "Content-Type: application/json" \
  -d '{"user_id": "user_123"}'
```

**Response:**
```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "bearer"
}
```

### üöÄ Usando o Token

Copie o `access_token` retornado e use-o para autenticar suas requisi√ß√µes aos outros endpoints.

**Exemplo com cURL:**
```bash
# Substitua <seu_token_jwt> pelo token gerado
curl -X GET "http://127.0.0.1:8000/v1/models" \
  -H "Authorization: Bearer <seu_token_jwt>"
```

---


## 5. Refer√™ncia da API

A documenta√ß√£o completa e interativa de todos os endpoints est√° dispon√≠vel no Swagger UI em `http://127.0.0.1:8000/docs`.

### Principais Endpoints

#### Chat Completions

- **`POST /v1/chat/completions`**: Envia um prompt para um modelo de IA e recebe uma resposta. Este √© o endpoint principal para intera√ß√µes de chat.

#### Modelos

- **`GET /v1/models`**: Lista todos os modelos de IA dispon√≠veis na plataforma, incluindo seus IDs, provedores e modos suportados.

#### Conversas

- **`POST /v1/conversations`**: Cria uma nova conversa vazia.
- **`GET /v1/conversations`**: Lista todas as conversas de um usu√°rio.
- **`GET /v1/conversations/{id}`**: Obt√©m os detalhes e o hist√≥rico de mensagens de uma conversa espec√≠fica.
- **`PUT /v1/conversations/{id}/title`**: Atualiza o t√≠tulo de uma conversa.
- **`POST /v1/conversations/{id}/favorite`**: Marca ou desmarca uma conversa como favorita.
- **`DELETE /v1/conversations/{id}`**: Deleta uma conversa e todo o seu hist√≥rico.

#### Gera√ß√£o de Imagens

- **`POST /v1/images/generate`**: Gera uma imagem com base em um prompt de texto usando DALL-E 3.

#### Web Search

- **`POST /v1/search`**: Realiza uma busca na web usando o Google Search.

#### Pre√ßos e Cr√©ditos

- **`GET /v1/pricing`**: Retorna a tabela de pre√ßos completa, com o custo em cr√©ditos para cada modelo.
- **`GET /v1/pricing/{model}`**: Retorna o pre√ßo de um modelo espec√≠fico.
- **`GET /v1/images/pricing`**: Retorna o custo para gera√ß√£o de imagens.
- **`GET /v1/search/pricing`**: Retorna o custo para uma busca na web.

---



## 6. Sistema de Cr√©ditos e Pre√ßos

A plataforma opera com um sistema de cr√©ditos pr√©-pagos para o uso dos modelos de IA. Esta se√ß√£o detalha como os custos s√£o calculados e apresentados.

### üí∞ C√°lculo de Cr√©ditos

O custo de cada requisi√ß√£o √© calculado com base nos seguintes fatores:

- **Modelo Utilizado:** Modelos mais avan√ßados (como Claude Opus) custam mais caro.
- **Tokens de Entrada (Prompt):** O n√∫mero de tokens no seu prompt.
- **Tokens de Sa√≠da (Resposta):** O n√∫mero de tokens na resposta gerada pela IA.

> **F√≥rmula:** `Custo em Cr√©ditos = (Custo da API em USD * Margem de Lucro) * Taxa de Convers√£o`

- **Margem de Lucro:** 30%
- **Taxa de Convers√£o:** 1 USD = 100 cr√©ditos

### üìä Tabela de Pre√ßos

A tabela de pre√ßos completa pode ser consultada via API no endpoint `GET /v1/pricing`.

**Custo em Cr√©ditos por 1.000 Tokens:**

| Modelo | Input (1K tokens) | Output (1K tokens) | Categoria |
|:---|---:|---:|:---|
| **OpenAI GPT** | | | |
| GPT-5 Pro | 0.16 | 1.30 | Premium |
| GPT-5 Mini | 0.08 | 0.31 | Econ√¥mico |
| **Anthropic Claude** | | | |
| Claude Opus 4.1 | 1.95 | 9.75 | Ultra Premium |
| Claude Sonnet 4.5 | 0.39 | 1.95 | Premium |
| Claude Haiku 4.5 | 0.13 | 0.65 | Balanceado |
| **Google Gemini** | | | |
| Gemini 2.5 Pro | 0.16 | 1.30 | Premium |
| Gemini 2.5 Flash | 0.04 | 0.16 | Econ√¥mico |

### üñºÔ∏è Custos de Servi√ßos Adicionais

- **Gera√ß√£o de Imagens (DALL-E 3):**
  - **Standard:** 5 cr√©ditos por imagem
  - **HD:** 10 cr√©ditos por imagem
- **Web Search (Google):** 1 cr√©dito por busca

### üìà Informa√ß√µes de Uso na Resposta

Cada resposta do endpoint `POST /v1/chat/completions` e dos servi√ßos adicionais inclui um objeto `usage` com detalhes sobre o custo daquela requisi√ß√£o espec√≠fica.

**Exemplo de Objeto `usage`:**
```json
"usage": {
  "prompt_tokens": 50,
  "completion_tokens": 20,
  "total_tokens": 70,
  "cost_usd": 0.000263,
  "cost_credits": 3
}
```

O sistema principal da plataforma deve usar o campo `cost_credits` para debitar o valor do saldo do usu√°rio.

---


## 7. Seguran√ßa

A seguran√ßa √© um pilar fundamental da NexusAI API. Para um guia detalhado sobre as pr√°ticas de seguran√ßa implementadas, consulte o arquivo [SECURITY.md](SECURITY.md).

### Principais Medidas

- **Autentica√ß√£o JWT:** Todas as requisi√ß√µes s√£o autenticadas.
- **Prote√ß√£o de Chaves:** As chaves de API dos provedores s√£o armazenadas de forma segura em vari√°veis de ambiente e nunca expostas.
- **Isolamento de Dados:** A l√≥gica da aplica√ß√£o garante que um usu√°rio s√≥ possa acessar suas pr√≥prias conversas.
- **CORS:** Configura√ß√£o de Cross-Origin Resource Sharing para permitir requisi√ß√µes apenas de origens confi√°veis.

---

## 8. Estrutura do Projeto

O projeto segue uma estrutura modular e organizada para facilitar a manuten√ß√£o e a escalabilidade.

```
/nexusai_api
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ api/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ v1/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ endpoints/  # L√≥gica dos endpoints (chat, conversas, etc.)
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ schemas.py    # Schemas Pydantic para valida√ß√£o
‚îÇ   ‚îú‚îÄ‚îÄ core/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ config.py     # Configura√ß√µes e vari√°veis de ambiente
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ security.py   # L√≥gica de autentica√ß√£o JWT
‚îÇ   ‚îú‚îÄ‚îÄ db/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ mongodb.py    # Conex√£o com o MongoDB (Motor)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ models.py     # Modelos de dados do banco
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ conversation_repository.py # L√≥gica de acesso ao BD
‚îÇ   ‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ providers/    # Padr√£o Strategy com os providers de IA
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ llm_orchestrator.py # Orquestrador que seleciona o provider
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pricing.py      # L√≥gica de c√°lculo de custos e cr√©ditos
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ image_generator.py # Servi√ßo de gera√ß√£o de imagens
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ web_search.py   # Servi√ßo de busca na web
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îî‚îÄ‚îÄ main.py         # Ponto de entrada da aplica√ß√£o FastAPI
‚îú‚îÄ‚îÄ tests/              # Testes unit√°rios e de integra√ß√£o
‚îú‚îÄ‚îÄ .env                # Arquivo com suas chaves (N√ÉO VERSIONAR)
‚îú‚îÄ‚îÄ .env.example        # Arquivo de exemplo para vari√°veis de ambiente
‚îú‚îÄ‚îÄ .gitignore          # Arquivos e pastas a serem ignorados pelo Git
‚îú‚îÄ‚îÄ DOCUMENTATION.md    # Esta documenta√ß√£o
‚îú‚îÄ‚îÄ PRICING_PLAN.md     # Detalhes do plano de neg√≥cios e cr√©ditos
‚îú‚îÄ‚îÄ README.md           # Readme principal do projeto
‚îú‚îÄ‚îÄ requirements.txt    # Depend√™ncias do projeto
‚îî‚îÄ‚îÄ SECURITY.md         # Guia de seguran√ßa
```

---

## 9. Deploy

Para fazer o deploy da API em um ambiente de produ√ß√£o, siga estas recomenda√ß√µes.

### üê≥ Usando Docker (Recomendado)

A maneira mais f√°cil e segura de fazer o deploy √© usando Docker e Docker Compose.

1.  **Crie um `Dockerfile`:**

    ```dockerfile
    # Dockerfile
    FROM python:3.11-slim

    WORKDIR /app

    COPY requirements.txt .
    RUN pip install --no-cache-dir -r requirements.txt

    COPY ./app /app/app

    EXPOSE 8000

    CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000"]
    ```

2.  **Crie um `docker-compose.yml`:**

    ```yaml
    # docker-compose.yml
    version: '3.8'
    services:
      nexusai_api:
        build: .
        ports:
          - "8000:8000"
        env_file:
          - .env.production
        depends_on:
          - mongodb

      mongodb:
        image: mongo:latest
        volumes:
          - mongo_data:/data/db
        ports:
          - "27017:27017"

    volumes:
      mongo_data:
    ```

3.  **Crie um arquivo `.env.production`** com as vari√°veis de ambiente para produ√ß√£o (usando chaves de produ√ß√£o e uma `JWT_SECRET_KEY` forte).

4.  **Inicie os containers:**

    ```bash
    docker-compose up -d
    ```

### ‚òÅÔ∏è Op√ß√µes de Hospedagem

- **Render:** Plataforma PaaS com um plano gratuito generoso, ideal para projetos acad√™micos e de pequeno porte. Suporta Docker e bancos de dados gerenciados.
- **Fly.io:** Outra plataforma PaaS com um plano gratuito, focada em deploy de containers.
- **Google Cloud Run:** Solu√ß√£o serverless do Google que escala automaticamente, inclusive para zero. Custo-benef√≠cio excelente para APIs com tr√°fego vari√°vel.
- **AWS (EC2, ECS, EKS):** Solu√ß√µes mais robustas e complexas, ideais para aplica√ß√µes de grande escala.

### ‚úÖ Checklist de Produ√ß√£o

Antes de fazer o deploy em produ√ß√£o:

- [ ] Mude `DEBUG` para `False` no seu arquivo `.env.production`.
- [ ] Configure `CORS_ORIGINS` para permitir apenas o dom√≠nio do seu frontend.
- [ ] Use uma `JWT_SECRET_KEY` forte e √∫nica.
- [ ] Remova o endpoint de teste `/v1/auth/token`.
- [ ] Configure um banco de dados de produ√ß√£o (como o MongoDB Atlas) em vez de um container local.
- [ ] Configure logs e monitoramento.


